# Redis Infrastructure

## ÔøΩ Data Structure

Redis stores embeddings, logs, and cache data.

### Docker Compose (Recommended)
```yaml
# From backend/docker-compose.yml
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
```

### Environment Variables
```bash
REDIS_HOST=localhost
REDIS_PORT=6379
# No password required for local development
```

## üì¶ Data Structure

### Cache Keys Used by the System
```bash
# Embeddings (generated by scripts/generate-embeddings.ts)
cache:embedding:https://ajuda.infinitepay.io/pt-BR/articles/...

# Quick cache for optimized article loading
cache:processed_articles:quick

# General context cache
cache:context:*

# Conversation history (future feature)
chat:history:*
```

## üîç Useful Commands

### Monitoring
```bash
# Check Redis info
redis-cli info

# Monitor real-time commands
redis-cli monitor

# Check memory usage
redis-cli info memory
```

### Data Management
```bash
# Count embeddings
redis-cli KEYS "cache:embedding:*" | wc -l

# Clear all embeddings
redis-cli --eval "redis.call('del', unpack(redis.call('keys', 'cache:embedding:*')))" 0

# Clear quick cache (forces article reload)
redis-cli DEL "cache:processed_articles:quick"

# Flush all data (nuclear option)
redis-cli FLUSHDB
```

### Debugging
```bash
# Check specific embedding
redis-cli GET "cache:embedding:https://ajuda.infinitepay.io/pt-BR/articles/6033460806678"

# List all keys
redis-cli KEYS "*"

# Get key info
redis-cli TYPE "cache:embedding:*"
redis-cli TTL "cache:embedding:*"
```

## üö® Troubleshooting

### Redis Not Starting
```bash
# Check if port is in use
lsof -i :6379

# Stop existing Redis
docker compose down redis

# Restart with logs
docker compose up redis
```

### Data Loss Issues
- **Cause**: Redis not configured for persistence
- **Solution**: Use `appendonly yes` in redis.conf or Docker command
- **Recovery**: Re-run `pnpm tsx scripts/generate-embeddings.ts`

### Memory Issues
```bash
# Check memory usage
redis-cli info memory

# Clear old data
redis-cli FLUSHDB
```

## üîí Production Considerations

### Security
- Enable authentication: `requirepass your_password`
- Bind to specific interfaces: `bind 127.0.0.1`
- Use TLS for external connections

### Performance
- Set appropriate `maxmemory` limit
- Configure eviction policy: `maxmemory-policy allkeys-lru`
- Monitor with Redis monitoring tools

### Backup
- Enable AOF: `appendonly yes`
- Schedule RDB snapshots
- Store backups externally
